---
weight: 1
---

# 三次握手

## 1 什么是三次握手

![三次握手](../../../media/202105/2021-05-04_153445.png)

1. **第一次握手：**`Client` 将`SYN` 置为 1，随机产生一个初始序列号`seq` 发送给`Server`，进入`SYN_SENT` 状态。
2. **第二次握手：**`Server` 收到`Client` 的`SYN=1` 后，知道客户端请求建立连接，将自己的`SYN` 置为 1，`ACK` 置为 1，产生一个`acknowledge number = seq + 1`，并随机产生一个自己的初始序列号，发送给客户端，进入`SYN_RCVD` 状态。
3. **第三次握手：** 客户端检查`acknowledge number` 是否为序列号 +1，`ACK` 是否为 1，检查正确之后，将自己的`ACK` 置为 1，产生一个`acknowledge number = 服务器发的序列号 + 1`，发送给服务器，进入`ESTBLISHED` 状态；服务器检查`ACK` 为 1，`acknowledge number = 序列号 + 1` 之后，也进入`ESTBLISHED` 状态，完成三次握手，连接建立。

## 2 三次握手的必要性

1. **第一次握手**：**客户端发送网络包**，**服务端收到了**，这样服务端就能得出结论，**客户端的发送能力**、**服务端的接收能力是正常的**。
2. **第二次握手**：**服务端发送网络包**，**客户端收到了**，这样客户端就能得出结论，**服务端的接收能力**、**发送能力**、**客户端的接收**、**发送能力是正常的**，不过**此时服务器并不能确认客户端的接收能力是否正常**。
3. **第三次握手**：**客户端发送网络包**，**服务端收到了**，这样服务器就能得出结论，**客户端的接收能力**、**服务端的接收能力是正常的**。

## 3 TCP 连接可以两次握手吗

不可以，主要有两个原因：

1. **可能会出现已失效的连接请求报文段又传到了服务器端。**
   1. `Client` 发出的第一个连接请求报文段并没有丢失，而是在某个网络节点长时间的滞留了，以延误到连接释放以后的某个时间才到达`Server`。
   2. 本来这是一个早已失效的报文段，但`Server` 收到此失效的连接请求报文段后，就误认为是`Client` 再次发出的一个新的连接请求，于是就向`Client` 发出确认报文段，同意建立连接。
   3. 如果不采用三次握手，那么只要`Server` 发出确认，新的连接就建立了。
   4. 由于现在`Client` 并没有发出建立连接的请求，因此不会理睬`Server` 的确认，也不会向`Server` 发送数据，但`Server` 却认为新的连接已经建立，并一直等待`Client` 发来数据，这样，`Server` 的很多资源就白白浪费掉了。
   5. 采用三次握手的办法就可以防止上述现象发生，就像刚才那种情况，`Client` 不会向`Server` 的确认发出确认，`Server` 由于收不到确认，就知道`Client` 并没有要求建立连接。
2. **无法保证 `Client` 正确接收第二次握手的报文（`Server` 无法确认 `Client` 是否收到），也无法保证 `Client` 和 `Server` 之间成功互换初始序列号**。

## 4 可以采用四次握手吗

可以，但是会降低传输的效率。

1. 四次握手是指：第二次握手`Server` 只发送`ACK` 和`acknowledge number`，而`Server` 的`SYN` 和初始序列号在第三次握手时发送，原来协议中的第三次握手变为第四次握手。
2. 出于优化的目的，四次握手中的二、三可以合并。

## 5 第三次握手中，如果客户端的 ACK 未送达服务器，会怎样

* **Server 端：** 由于没有收到`ACK` 确认，因此会重发之前的`SYN+ACK`（默认重发 5 次，之后自动关闭连接进入`CLOSED` 状态），`Client` 收到后会重新传`ACK` 给`Server`。
* **Client 端：**
  1. 在`Server` 进行超时重发的过程中，如果`Client` 向服务器发送数据，数据头部的`ACK` 是为 1 的，所以服务器收到数据之后会读取`ACK Number`，进入`ESTABLISHED` 状态。
  2. 在`Server` 进入`CLOSED` 状态之后，如果`Client` 向服务器发送数据，服务器会以`RST` 包应答。

## 6 如果已经建立了连接，但客户端出现了故障怎么办

1. 服务器每收到一次客户端的请求后都会重新复位一个计数器，时间通常是设置为 2 小时，若 2 小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔 75 秒钟发送一次。
2. 若一连发送 10 个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。

## 7 初始序列号是什么

1. `TCP` 连接的一方`A`，**随机选择一个 32 为序列号**作为发送数据的初始序列号，比如为 1000，然后以该序列号为原点，对要传送的数据进行编号：1001、1002...。
2. 三次握手时，把这个序列号传送给另一方`B`，以便在数据传输时，`B` 可以**确认什么样的数据编号是合法的**。
3. 同时在进行数据传输时，**`A` 还可以确认 `B` 收到的每一个字节**，如果`A` 收到了`B` 的确认编号是 2001，就说明编号为 1001-2000 的数据已经被`B` 成功接受。

## 参考文献

1. [什么是三次握手 (three-way handshake)？](https://github.com/wolverinn/Waking-Up/blob/master/Computer%20Network.md#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B-three-way-handshake)。
2. [关于三次握手与四次挥手你要知道这些](https://mp.weixin.qq.com/s?__biz=MzUyNzgyNzAwNg==&mid=2247483765&idx=1&sn=70179fa0e28aacd42d4c15dbd08bc6fc)。
